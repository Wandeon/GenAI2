# Sprint 0.4: Context + Mobile Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Complete the Observatory experience with context panel integration and mobile support. This is the final sprint of Phase 0 - the "Wow Slice" that produces the "holy crap" reaction.

**Architecture:** Create selection context to share selected event state. Add mobile bottom navigation with tabs. Implement swipe gestures for lane navigation on mobile.

**Tech Stack:** Next.js 16, React Context, Tailwind CSS responsive classes, touch events

---

## Sprint Scope

**IN SCOPE:**
- Context panel shows selected event details
- Mobile tab navigation (bottom bar)
- Mobile swipe between lanes
- Tested on 375px width
- Lighthouse Performance ‚â• 85, Accessibility ‚â• 90

**OUT OF SCOPE:**
- Evidence snapshots (Phase 1)
- Full mobile app (PWA) features
- Offline support

---

## Current State Analysis

**Problems to Solve:**

1. **Event Selection Disconnected**
   - `ObservatoryShell` has `selectedEvent` state (lines 28, 48)
   - `ObservatoryPage` has `selectedEventId` state (line 10)
   - They're not connected - clicking an event doesn't show details in context panel

2. **Mobile Hidden Elements**
   - Sidebar: `hidden lg:block` (not shown on mobile)
   - Context Panel: `hidden xl:block` (not shown on mobile/tablet)
   - No mobile navigation exists

3. **No Lane Switching on Mobile**
   - Mobile shows all 3 lanes stacked (`grid-cols-1`)
   - Need tab-based switching with swipe

---

## Task 1: Create Selection Context

**Files:**
- Create: `apps/web/src/context/selection-context.tsx`

### Implementation

```typescript
// apps/web/src/context/selection-context.tsx
"use client";

import {
  createContext,
  useContext,
  useState,
  useCallback,
  useMemo,
  type ReactNode,
} from "react";
import type { NormalizedEvent } from "@genai/shared";

interface SelectionContextValue {
  // Currently selected event (full data)
  selectedEvent: NormalizedEvent | null;

  // Select an event
  selectEvent: (event: NormalizedEvent) => void;

  // Clear selection
  clearSelection: () => void;

  // Is context panel open on mobile?
  isContextOpen: boolean;
  setContextOpen: (open: boolean) => void;
}

const SelectionContext = createContext<SelectionContextValue | null>(null);

export function SelectionProvider({ children }: { children: ReactNode }) {
  const [selectedEvent, setSelectedEvent] = useState<NormalizedEvent | null>(null);
  const [isContextOpen, setContextOpen] = useState(false);

  const selectEvent = useCallback((event: NormalizedEvent) => {
    setSelectedEvent(event);
    setContextOpen(true); // Auto-open context on mobile when selecting
  }, []);

  const clearSelection = useCallback(() => {
    setSelectedEvent(null);
    setContextOpen(false);
  }, []);

  const value = useMemo(
    () => ({
      selectedEvent,
      selectEvent,
      clearSelection,
      isContextOpen,
      setContextOpen,
    }),
    [selectedEvent, selectEvent, clearSelection, isContextOpen]
  );

  return (
    <SelectionContext.Provider value={value}>
      {children}
    </SelectionContext.Provider>
  );
}

export function useSelection() {
  const context = useContext(SelectionContext);
  if (!context) {
    throw new Error("useSelection must be used within a SelectionProvider");
  }
  return context;
}
```

### Step: Verify and commit

Run: `pnpm build && pnpm typecheck`
Commit: `feat(selection): add selection context for event details`

---

## Task 2: Wire Selection to Observatory

**Files:**
- Modify: `apps/web/src/app/observatory/layout.tsx` - Add SelectionProvider
- Modify: `apps/web/src/app/observatory/page.tsx` - Use selectEvent from context
- Modify: `apps/web/src/components/layout/observatory-shell.tsx` - Remove local state
- Modify: `apps/web/src/components/layout/context-panel.tsx` - Use selection context

### Implementation

1. Add SelectionProvider to layout (wrap with TimeProvider)
2. Update page to pass full event to selectEvent, not just ID
3. Update shell to get selectedEvent from context
4. Update context panel to use useSelection hook

### Step: Verify and commit

Run: `pnpm build && pnpm typecheck`
Commit: `feat(selection): wire selection context to observatory`

---

## Task 3: Enhance Context Panel with URL/Link

**Files:**
- Modify: `apps/web/src/components/layout/context-panel.tsx`

### Implementation

Add "View Source" button that opens the event URL:

```typescript
// In context panel, add to the event details section
{selectedEvent.url && (
  <div className="pt-4 border-t">
    <a
      href={selectedEvent.url}
      target="_blank"
      rel="noopener noreferrer"
      className="inline-flex items-center gap-2 text-sm text-primary hover:underline"
    >
      <span>Pogledaj izvor</span>
      <span>‚Üó</span>
    </a>
  </div>
)}
```

Also add source type indicator (HN, GitHub, arXiv icon).

### Step: Verify and commit

Run: `pnpm build && pnpm typecheck`
Commit: `feat(context): add source link and type indicator to context panel`

---

## Task 4: Create Mobile Bottom Navigation

**Files:**
- Create: `apps/web/src/components/layout/mobile-nav.tsx`
- Modify: `apps/web/src/components/layout/observatory-shell.tsx`

### Implementation

```typescript
// apps/web/src/components/layout/mobile-nav.tsx
"use client";

import { cn } from "@genai/ui";

interface MobileNavProps {
  activeTab: "hn" | "github" | "arxiv";
  onTabChange: (tab: "hn" | "github" | "arxiv") => void;
}

const tabs = [
  { id: "hn" as const, label: "HN", icon: "üî∂" },
  { id: "github" as const, label: "GitHub", icon: "üêô" },
  { id: "arxiv" as const, label: "Radovi", icon: "üìÑ" },
];

export function MobileNav({ activeTab, onTabChange }: MobileNavProps) {
  return (
    <nav className="fixed bottom-0 left-0 right-0 bg-card border-t md:hidden safe-area-inset-bottom">
      <div className="flex justify-around">
        {tabs.map((tab) => (
          <button
            key={tab.id}
            onClick={() => onTabChange(tab.id)}
            className={cn(
              "flex-1 flex flex-col items-center py-3 text-xs",
              activeTab === tab.id
                ? "text-primary"
                : "text-muted-foreground"
            )}
          >
            <span className="text-lg">{tab.icon}</span>
            <span>{tab.label}</span>
          </button>
        ))}
      </div>
    </nav>
  );
}
```

Add to shell, visible only on mobile (md:hidden).

### Step: Verify and commit

Run: `pnpm build && pnpm typecheck`
Commit: `feat(mobile): add bottom tab navigation for mobile`

---

## Task 5: Create Mobile Lane Context

**Files:**
- Create: `apps/web/src/context/mobile-lane-context.tsx`
- Modify: `apps/web/src/app/observatory/layout.tsx`

### Implementation

Context to track which lane is active on mobile:

```typescript
// apps/web/src/context/mobile-lane-context.tsx
"use client";

import { createContext, useContext, useState, useMemo, type ReactNode } from "react";

type LaneId = "hn" | "github" | "arxiv";

interface MobileLaneContextValue {
  activeLane: LaneId;
  setActiveLane: (lane: LaneId) => void;
}

const MobileLaneContext = createContext<MobileLaneContextValue | null>(null);

export function MobileLaneProvider({ children }: { children: ReactNode }) {
  const [activeLane, setActiveLane] = useState<LaneId>("hn");

  const value = useMemo(() => ({ activeLane, setActiveLane }), [activeLane]);

  return (
    <MobileLaneContext.Provider value={value}>
      {children}
    </MobileLaneContext.Provider>
  );
}

export function useMobileLane() {
  const context = useContext(MobileLaneContext);
  if (!context) {
    throw new Error("useMobileLane must be used within a MobileLaneProvider");
  }
  return context;
}
```

### Step: Verify and commit

Run: `pnpm build && pnpm typecheck`
Commit: `feat(mobile): add mobile lane context for tab switching`

---

## Task 6: Update Observatory Page for Mobile Lanes

**Files:**
- Modify: `apps/web/src/app/observatory/page.tsx`

### Implementation

Show only active lane on mobile, all lanes on desktop:

```typescript
// apps/web/src/app/observatory/page.tsx
import { useMobileLane } from "@/context/mobile-lane-context";

export default function ObservatoryPage() {
  const { activeLane } = useMobileLane();
  // ... existing code ...

  return (
    <div className="h-full">
      {/* Desktop: 3 columns */}
      <div className="hidden md:grid md:grid-cols-3 gap-4 h-full">
        <Lane title="Hacker News" ...>{/* HN events */}</Lane>
        <Lane title="GitHub" ...>{/* GitHub events */}</Lane>
        <Lane title="Radovi" ...>{/* arXiv events */}</Lane>
      </div>

      {/* Mobile: Single lane based on active tab */}
      <div className="md:hidden h-full pb-16"> {/* pb-16 for bottom nav */}
        {activeLane === "hn" && (
          <Lane title="Hacker News" ...>{/* HN events */}</Lane>
        )}
        {activeLane === "github" && (
          <Lane title="GitHub" ...>{/* GitHub events */}</Lane>
        )}
        {activeLane === "arxiv" && (
          <Lane title="Radovi" ...>{/* arXiv events */}</Lane>
        )}
      </div>
    </div>
  );
}
```

### Step: Verify and commit

Run: `pnpm build && pnpm typecheck`
Commit: `feat(mobile): show single lane based on active tab on mobile`

---

## Task 7: Add Swipe Gesture Support

**Files:**
- Create: `apps/web/src/hooks/use-swipe.ts`
- Modify: `apps/web/src/app/observatory/page.tsx`

### Implementation

```typescript
// apps/web/src/hooks/use-swipe.ts
"use client";

import { useRef, useCallback } from "react";

interface UseSwipeOptions {
  onSwipeLeft?: () => void;
  onSwipeRight?: () => void;
  threshold?: number;
}

export function useSwipe({ onSwipeLeft, onSwipeRight, threshold = 50 }: UseSwipeOptions) {
  const touchStartX = useRef<number | null>(null);

  const handleTouchStart = useCallback((e: React.TouchEvent) => {
    touchStartX.current = e.touches[0].clientX;
  }, []);

  const handleTouchEnd = useCallback(
    (e: React.TouchEvent) => {
      if (touchStartX.current === null) return;

      const touchEndX = e.changedTouches[0].clientX;
      const diff = touchStartX.current - touchEndX;

      if (Math.abs(diff) > threshold) {
        if (diff > 0) {
          onSwipeLeft?.();
        } else {
          onSwipeRight?.();
        }
      }

      touchStartX.current = null;
    },
    [onSwipeLeft, onSwipeRight, threshold]
  );

  return { handleTouchStart, handleTouchEnd };
}
```

Use in observatory page for lane switching:

```typescript
const { activeLane, setActiveLane } = useMobileLane();

const lanes: LaneId[] = ["hn", "github", "arxiv"];
const currentIndex = lanes.indexOf(activeLane);

const { handleTouchStart, handleTouchEnd } = useSwipe({
  onSwipeLeft: () => {
    if (currentIndex < lanes.length - 1) {
      setActiveLane(lanes[currentIndex + 1]);
    }
  },
  onSwipeRight: () => {
    if (currentIndex > 0) {
      setActiveLane(lanes[currentIndex - 1]);
    }
  },
});
```

### Step: Verify and commit

Run: `pnpm build && pnpm typecheck`
Commit: `feat(mobile): add swipe gestures for lane switching`

---

## Task 8: Mobile Context Panel (Sheet/Modal)

**Files:**
- Modify: `apps/web/src/components/layout/context-panel.tsx`

### Implementation

On mobile, show context panel as a bottom sheet when event is selected:

```typescript
// apps/web/src/components/layout/context-panel.tsx
import { useSelection } from "@/context/selection-context";

export function ContextPanel() {
  const { selectedEvent, clearSelection, isContextOpen } = useSelection();

  // Desktop version (unchanged)
  // ...existing desktop implementation with hidden xl:block

  // Mobile version - bottom sheet
  if (isContextOpen && selectedEvent) {
    return (
      <>
        {/* Backdrop */}
        <div
          className="fixed inset-0 bg-black/50 z-40 xl:hidden"
          onClick={clearSelection}
        />
        {/* Sheet */}
        <aside className="fixed bottom-0 left-0 right-0 bg-card rounded-t-xl z-50 max-h-[70vh] overflow-y-auto xl:hidden animate-in slide-in-from-bottom">
          {/* Same content as desktop but in sheet format */}
        </aside>
      </>
    );
  }

  return null; // Mobile: no panel when not selected
}
```

### Step: Verify and commit

Run: `pnpm build && pnpm typecheck`
Commit: `feat(mobile): add bottom sheet context panel for mobile`

---

## Task 9: Header Responsive Adjustments

**Files:**
- Modify: `apps/web/src/components/layout/header.tsx`
- Modify: `apps/web/src/components/time-machine.tsx`

### Implementation

1. Hide TimeMachine scrubber on very small screens, show simplified version
2. Collapse search on mobile (icon only, expands on tap)
3. Ensure header fits on 375px

```typescript
// Simplified mobile header
<header className="border-b bg-card">
  {/* Mobile header */}
  <div className="md:hidden flex items-center justify-between p-2">
    <span className="font-bold">GenAI.hr</span>
    <div className="flex items-center gap-2">
      {/* Simplified time indicator */}
      {isInPast && (
        <span className="text-amber-500 text-xs">
          {targetTimestamp.toLocaleDateString("hr-HR", { day: "numeric", month: "short" })}
        </span>
      )}
      <button onClick={() => {/* toggle search */}}>üîç</button>
    </div>
  </div>

  {/* Desktop header - unchanged */}
  <div className="hidden md:block p-4">
    {/* existing implementation */}
  </div>
</header>
```

### Step: Verify and commit

Run: `pnpm build && pnpm typecheck`
Commit: `feat(mobile): responsive header with mobile-friendly layout`

---

## Task 10: Lighthouse Audit + Fixes

**Files:**
- Various accessibility and performance fixes

### Steps

1. Run Lighthouse on `/observatory` page
2. Fix accessibility issues:
   - Add aria-labels where needed
   - Ensure color contrast
   - Add focus indicators
3. Fix performance issues:
   - Lazy load non-critical components
   - Optimize images if any
4. Target: Performance ‚â• 85, Accessibility ‚â• 90

### Step: Verify and commit

Run: `pnpm build && pnpm typecheck`
Commit: `fix(a11y): lighthouse accessibility and performance improvements`

---

## Task 11: Final Verification + Push

### Step 1: Full verification

```bash
pnpm build
pnpm typecheck
pnpm lint
```

### Step 2: Verify Sprint 0.4 exit gates

**Gate: Context Panel**
- [ ] Click event ‚Üí context panel shows details
- [ ] Context panel shows: title, date, source count, topics
- [ ] "View source" link works

**Gate: Mobile Tab Navigation**
- [ ] Bottom nav visible on mobile (< md)
- [ ] Tabs switch between lanes
- [ ] Active tab is highlighted

**Gate: Mobile Swipe**
- [ ] Swipe left ‚Üí next lane
- [ ] Swipe right ‚Üí previous lane

**Gate: 375px Width**
- [ ] All content visible
- [ ] No horizontal scroll
- [ ] Readable text sizes
- [ ] Touch targets ‚â• 44px

**Gate: Lighthouse**
- [ ] Performance ‚â• 85
- [ ] Accessibility ‚â• 90

### Step 3: Update ROADMAP.md

Mark Sprint 0.4 items as complete, Phase 0 as complete.

### Step 4: Commit and push

```bash
git add .
git commit -m "docs: mark Sprint 0.4 and Phase 0 complete"
git push origin main
```

---

## Sprint 0.4 Exit Gate

- [ ] Context panel shows selected event details
- [ ] Mobile tab navigation works
- [ ] Mobile swipe between lanes works
- [ ] Tested on 375px width
- [ ] Lighthouse Performance ‚â• 85
- [ ] Lighthouse Accessibility ‚â• 90
- [ ] Build passes
- [ ] Typecheck passes

**Success:** Phase 0 complete - Observatory renders real data, Time Machine interactive, works on desktop + mobile

---

## Files Summary

### To Create
- `apps/web/src/context/selection-context.tsx`
- `apps/web/src/context/mobile-lane-context.tsx`
- `apps/web/src/components/layout/mobile-nav.tsx`
- `apps/web/src/hooks/use-swipe.ts`

### To Modify
- `apps/web/src/app/observatory/layout.tsx`
- `apps/web/src/app/observatory/page.tsx`
- `apps/web/src/components/layout/observatory-shell.tsx`
- `apps/web/src/components/layout/context-panel.tsx`
- `apps/web/src/components/layout/header.tsx`
- `apps/web/src/components/time-machine.tsx`
- `docs/ROADMAP.md`

---

## Technical Notes

### Mobile Breakpoints

```
sm: 640px
md: 768px   ‚Üê Mobile/Desktop breakpoint for lanes
lg: 1024px  ‚Üê Sidebar visible
xl: 1280px  ‚Üê Context panel visible (desktop)
```

### Safe Area Insets

For iPhone notch/home indicator:
```css
padding-bottom: env(safe-area-inset-bottom);
```

In Tailwind: `pb-safe` or custom class

### Touch Target Size

WCAG recommends minimum 44√ó44px for touch targets:
```css
min-height: 44px;
min-width: 44px;
```

### Performance Considerations

- Use CSS transforms for animations (GPU accelerated)
- Avoid layout shifts during tab changes
- Preload adjacent lanes for faster swipe
